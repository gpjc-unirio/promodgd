@using System.IO.MemoryMappedFiles
@model IEnumerable<Bpm2GP.Model.DataBase.Models.DesignMapping>

@{
    var map = Model.FirstOrDefault();
}

<script type="text/javascript">
    $(document).ready(function() {
        $('#tblMapping').DataTable({
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
        });

        $('[data-toggle="tooltip"]').tooltip();
    });

</script>

@if (map != null)
{
    //var groupProcessElements = map.AssociationConf.ElementsAssociated.GroupBy(g => g.ProcessElement.Name);

    <h3>Mapped From: @(map.AssociationConf.Name)</h3>
    if ((map.AssociationConf.Language != null) && (map.AssociationConf.Genre != null))
    {
        <small>(@("Language: [" + map.AssociationConf.Language.Name + "] and Genre: [" + map.AssociationConf.Genre.Name + "]"))</small>
        <br/>
    }
    <small>Creation Date: <strong>@map.CreationDate.ToShortDateString()</strong></small>
    <hr/>
    <h4>
        <i class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="top" title="Elements mapped in association by elements existents in the model."></i>
        <strong>Mapping Score: @(Math.Round(map.ModelScore * 100, 5))%</strong>
    </h4>
    <hr/>
    <table class="table table-striped table-responsive table-bordered" id="tblMapping">
        <thead>
        <tr>
            <th>
                @Html.DisplayName("Model Element")
            </th>
            <th>
                @Html.DisplayName("Game Genre Element")
            </th>
            <th>
                @Html.DisplayName("Mapped Element")
            </th>
        </tr>
        </thead>
        <tbody>
        @foreach (var element in map.AssociationConf.ElementsAssociated.OrderBy(o => o.ProcessElement.Name).ThenBy(t => t.GameGenreElement.Name).ToList())
        {
            var point = map.GameMappingScores.FirstOrDefault(f => f.GameGenreElementId == element.GameGenreElement.Id &&
                                                                  f.ModelElementId == element.ProcessElement.Id);

            <tr>
                <td style="vertical-align: middle;">
                    @element.ProcessElement.Name
                </td>

                <td style="vertical-align: middle;">
                    @element.GameGenreElement.Name
                    <br/>
                    <small style="color: silver">
                        Mapped: @(point != null ? (point.MappedElements + "/" + point.ExpectedElements) : "0/0")
                    </small>
                </td>
                <td style="vertical-align: middle;">
                    @{
                        var mappedElements = map.GameDesignMappingElements.Where(w => w.AssociateElement.Id == element.Id);
                    }

                    <div class="btn-group-sm horizontal">
                        @foreach (var mappedElement in mappedElements)
                        {
                            <div class="btn btn-default btn-sm">
                                <i class="glyphicon glyphicon-knight "></i> @mappedElement.Descricao
                                @if (!mappedElement.IsManual)
                                {
                                    <div class="btn btn-default btn-xs" data-toggle="tooltip" data-placement="right" title="Auto-Generated"><i class="glyphicon glyphicon-wrench"></i>
                                    </div>
                                }
                            </div><br/>
                        }
                    </div>
                </td>
            </tr>
        }
        </tbody>
        <tfoot></tfoot>
    </table>

    if (map.DesignMappingErrors.Count > 0)
    {
        <div class="alert alert-danger">
            <h5><strong>Errors:</strong></h5>
            @foreach (var error in map.DesignMappingErrors)
            {
                <details>
                    <summary>@error.Id</summary>
                    <p class="text-justify">@error.Error.Message </p>
                    <a href="#" class="btn btn-success btn-xs"> Ignore</a>
                </details>
                <br />
            }
        </div>
    }
}
